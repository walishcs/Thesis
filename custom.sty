\usepackage[linguistics]{forest}
\usepackage[utf8]{inputenc}
\usepackage{libertine}
\usepackage{libertinust1math}
\usepackage{unicode-math}
\usepackage{xeCJK}
\setCJKmainfont{AR PL UKai TW}
\setCJKmonofont{AR PL UKai TW}
\setCJKsansfont{AR PL UKai TW}
%\setCJKsansfont{Noto Serif CJK TC}
\usepackage{pdfpages}
\usepackage{pdflscape}
\usepackage{subfiles} % 引入子文件

% for back reference in bibliography
\usepackage[colorlinks,pdfusetitle]{hyperref}



% for DOI field
\usepackage{doi}
\hypersetup{hidelinks}
\hypersetup{breaklinks=true}

%%% Customization  %%%
\usepackage{acro}
\acsetup{make-links}
\usepackage{abbr} % 引入abbr.sty
\usepackage{longtable}
\usepackage{zhlipsum, lipsum}   % dummy text
\usepackage{graphicx}           % figures
\usepackage{float}
\usepackage{enumitem}
\usepackage{booktabs}           % tables
\usepackage{multirow}
\usepackage{array}
\usepackage{makecell}
\usepackage{arydshln}
\usepackage{gb4e} %Glossing 用
\noautomath %防止gb4e爆掉
\usepackage{etoolbox} %gb4e 第一行斜體
\pretocmd{\gll}{\def\eachwordone{\itshape}\def\eachwordtwo{\normalfont}}{}{}%gb4e 第一行斜體

%gb4e 行距
\newcommand{\setexamplelinespacing}{
    \renewcommand{\baselinestretch}{1.5}\selectfont
}
\AtBeginEnvironment{exe}{\setexamplelinespacing}

\usepackage[normalem]{ulem}
\useunder{\uline}{\ul}{}
\usepackage{multicol}
\usepackage{caption} 
\captionsetup[table]{skip=10pt} %表格caption間距
\setlength{\intextsep}{30pt plus 2pt minus 2pt} % 文本中的浮動體上下間距
\setlength{\textfloatsep}{20pt plus 2pt minus 4pt} % 頁面頂部或底部浮動體與文本之間的間距
\usepackage{chngpage} % allows for temporary adjustment of side margins
%\usepackage{cite}               % bibliography
\usepackage{xcolor} 
\usepackage{filecontents} %加入參考文獻說明

% subsubsection 以下層級 %
\usepackage{titlesec}

%標題字型
\usepackage{fontspec}
\newfontface\chapterfont{ChiayiCity.ttf}

\titleformat{\chapter}[display]
{\chapterfont\bfseries\filcenter}
{\huge\chaptername~\thechapter} %
{6ex}
{\Huge\thispagestyle{empty}}

% \titleformat{\section}
%   {\chapterfont\large\bfseries} % 使用指定的章節標題字型
%   {\thesection.}{10pt}{\large}

\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{2}
% subsubsection 以下層級 %


% % 以下是在圖表目錄加上前綴 %
\usepackage{tocloft} %TOC裡的Table Figure


\usepackage{float}
\usepackage{caption}

% 定義新的浮動環境 Map
\usepackage{newfloat}
\DeclareFloatingEnvironment[
    fileext=lom,
    listname={List of Maps},
    name=Map,
    placement=htbp,
    within=chapter
]{map}

% 使 Map 計數器隨章節重置
\usepackage{chngcntr}
\counterwithin{map}{chapter}

% 自定義 List of Maps 的項目格式
\newlistof{map}{lom}{List of Maps}


\renewcommand{\cfttoctitlefont}{\chapterfont\hspace*{\fill}\Huge\bfseries}
\renewcommand{\cftaftertoctitle}{\hspace*{\fill}}
\renewcommand{\cftlottitlefont}{\chapterfont\hspace*{\fill}\Huge\bfseries}
\renewcommand{\cftafterlottitle}{\hspace*{\fill}}
\renewcommand{\cftloftitlefont}{\chapterfont\hspace*{\fill}\Huge\bfseries}
\renewcommand{\cftafterloftitle}{\hspace*{\fill}}
\renewcommand{\cftlomtitlefont}{\chapterfont\hspace*{\fill}\Huge\bfseries}
\renewcommand{\cftafterlomtitle}{\hspace*{\fill}}

% 修改 List of Tables, Figures 的條目樣式

\renewcommand{\cfttabpresnum}{Table~} % List of FIgures set up <<<<<<<<
\setlength{\cfttabnumwidth}{5ex}
\setlength{\cfttabindent}{0ex}
\newlength{\tablen}% a pre tabure title length
\settowidth{\tablen}{\bfseries\cfttabpresnum} % the word Table~
\addtolength{\tablen}{\cfttabnumwidth}
\renewcommand{\cfttabnumwidth}{\tablen}

\renewcommand{\cftfigpresnum}{Figure~} % List of FIgures set up <<<<<<<<
\setlength{\cftfignumwidth}{5ex}
\setlength{\cftfigindent}{0ex}
\newlength{\figlen}% a pre figure title length
\settowidth{\figlen}{\bfseries\cftfigpresnum} % the word Figure~
\addtolength{\figlen}{\cftfignumwidth}
\renewcommand{\cftfignumwidth}{\figlen}

\renewcommand{\cftmappresnum}{Map~} % List of map set up <<<<<<<<<<<<<<<<
\setlength{\cftmapnumwidth}{5ex}
\setlength{\cftmapindent}{0ex}
\newlength{\maplen}% a pre photo  title length
\settowidth{\maplen}{\bfseries\cftmappresnum} % the word map~
\addtolength{\maplen}{\cftmapnumwidth}
\renewcommand{\cftmapnumwidth}{\maplen}


% 自訂指令 %
\newcommand{\shb}[1]{\textsuperscript{#1}}
\newcommand{\xb}[1]{\textsubscript{#1}}
\newcommand{\aikai}[1]{\textcolor{red}{\textbf{#1}}}
\newcommand{\cvc}{$\symbb{CVC}$\xspace}



% Bibliography


% \usepackage[sorting=nyt, backend=biber, style=authoryear-comp, dashed=false, maxcitenames=2, maxbibnames=99]{biblatex}
\usepackage[sorting=nyt, backend=biber, style=authoryear-comp, dashed=false, maxcitenames=2, maxbibnames=99, language=american]{biblatex} %phd thesis > dissertation
% , backref=true
%\defbibnote{bib-intro}{\textsf{\lipsum[1]}}

\setcounter{biburllcpenalty}{100}
\setcounter{biburlucpenalty}{200}
\setcounter{biburlnumpenalty}{100}


\addbibresource{ref.bib} %Import the bibliography file
\renewcommand*{\nameyeardelim}{\space}
\renewcommand*{\postnotedelim}{\addcolon\space}
\renewcommand*{\bibpagespunct}{\addcolon\space}
\DefineBibliographyStrings{english}{%
  page             = {},
  pages            = {},
} 
%\renewcommand*{\bibfont}{\footnotesize}

\newcommand{\sameyear}[1]{}

\usepackage{xpatch}
\AtEveryBibitem{\clearfield{month}}
\AtEveryCitekey{\clearfield{month}}
\xpatchbibmacro{date+extradate}{%
  \printtext[parens]%
}{%
  \setunit{\addperiod\space}%
  \printtext%
}{}{}

\NewBibliographyString{toappear}
\DefineBibliographyStrings{english}{%
  toappear = {to appear},
}

%Add comma between two authors in bibliography only
\AtBeginBibliography{\renewcommand*{\finalnamedelim}{
  \finalandcomma
  \addspace\bibstring{and}\space}  
 }

\DeclareFieldFormat[article,inproceedings,misc,inbook,incollection]{citetitle}{#1}
\DeclareFieldFormat[article,inproceedings,misc,inbook,incollection]{title}{#1}
\DeclareFieldFormat[thesis]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[article,book,inproceedings,misc,inbook,incollection,thesis]{addendum}{#1\nopunct}
\DeclareFieldFormat[article,inproceedings,misc,inbook,incollection,thesis]{volume}{#1}
\renewbibmacro{in:}{}

\DefineBibliographyStrings{american}{phdthesis = {PhD dissertation}}
\urlstyle{same}


%%END Bibliography Setup%%

\counterwithout{footnote}{chapter}    % \usepackage{chngcntr}這兩行的指令，若是沒有設定，\footnote 的編號是每個章節獨立計算！

% 此處開始是頁首頁尾設定

% 自訂格式
% \makeatletter
% \renewcommand{\chaptermark}[1]{\markboth{\textsc{#1}}{}}
% \renewcommand{\sectionmark}[1]{\markright{\thesection\quad \textsc{#1}}}
% \makeatother

\renewcommand{\chaptermark}[1]{%
\markboth{\thechapter\ \textsc{#1}}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ \textsc{#1}}}


\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead{} % 清除所有頁首設定
% \fancyhead[RE,LO]{\thepage}
\fancyhead[R]{\small \sffamily \thepage}
% \fancyhead[LE]{\small \sffamily \nouppercase{\leftmark}}
% \fancyhead[LO]{\small \sffamily \nouppercase{\rightmark}}
\fancyfoot{} % 清除所有頁尾設定
% \fancyfoot[C]{\small \sffamily \thepage}
% \renewcommand{\headrulewidth}{0.4pt} % 設定頁首多一條粗細是 0.4 pt 的水平線
% \renewcommand{\footrulewidth}{0.4pt} % 設定頁首多一條粗細是 0.4 pt 的水平線
% 移除標線
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% \setlength{\footskip}{40pt}

\fancypagestyle{appendixstyle}{
    \fancyhead{} % 清空預設樣式
    \fancyfoot{} % 清除所有頁尾設定
    \fancyhead[R]{\small \sffamily \thepage} 
    % \fancyhead[L]{\small \sffamily Appendix} % 中間頁眉顯示附錄標題
}

% 正文前的 plain 樣式（頁碼右上角）
\fancypagestyle{plain}{
    \fancyhf{}
    \fancyhead[R]{\small \sffamily \thepage} % 讓正文前的章節開頭頁碼在右上角
    \fancyfoot{}
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
}

% 正文開始後恢復預設 plain 樣式
\newcommand{\restoreDefaultPlain}{
    \fancypagestyle{plain}{
        \fancyhf{}
        \fancyfoot[C]{\thepage} % 讓正文的章節開頭頁碼回到頁尾
        \renewcommand{\headrulewidth}{0pt}
        \renewcommand{\footrulewidth}{0pt}
    }
}